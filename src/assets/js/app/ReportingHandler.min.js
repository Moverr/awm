
var currentChangedFil="ALL";var transactionsFromDate="0";var transactionsToDate="999999999999999";var ReportingHandler=function(){ReportingHandler.self=this;loanList.addDataModelChangedEventListenerCallback(ReportingHandler.prototype.dataModelChanged);savingsAccountList.addDataModelChangedEventListenerCallback(ReportingHandler.prototype.dataModelChanged);$("#TransactionsAccountReportTypeForm select").on("input",ReportingHandler.prototype.genericTransactionReportSelectHandler);ReportingHandler.self.pieChartConfig={series:{pie:{radius:0.7,innerRadius:0.3,show:true,stroke:{color:"rgba(255,255,255,1.0)",width:0},highlight:{opacity:0.25},offset:{top:0,left:0},label:{show:true,radius:3/4,formatter:function(a,b){return'<div style="border:1px solid grey;font-size:8pt;text-align:center;padding:5px;color:white;">'+a+" : "+Math.round(b.percent)+"%</div>"},background:{opacity:0.5,color:"#000"}},combine:{color:"#999",threshold:0.05}}},legend:{show:false},grid:{hoverable:true,clickable:true},tooltip:{show:true,content:"%p.0%, %s, n=%n",shifts:{x:20,y:0},defaultTheme:false}};this.commandStack=[];this.argumentStack=[]};function drawChart(b,e){var g=b.length;var f=new google.visualization.DataTable();f.addColumn("string","Topping");f.addColumn("number","Slices");b=b.sort(function(i,h){return i.data-h.data});for(var a=0;a<g;a++){console.log(b[a]);f.addRow([""+b[a].label,b[a].data])}var c={tooltip:{isHtml:true},pieHole:0.4,legend:{position:"bottom",alignment:"start"},colors:["#006600","#66cc00","#666666","#999999","#cccccc"]};var d=new google.visualization.PieChart(document.getElementById("panel-body-"+e));d.draw(f,c)}google.charts.load("current",{packages:["corechart"]});ReportingHandler.prototype.drawGoogleChart=function(b,a){google.charts.load("current",{packages:["corechart"]});google.charts.setOnLoadCallback(drawChart(b,a))};ReportingHandler.TRANSACTION_TITLES={transactionDate:"Date",accountType:"Account type",amount:"Amount",transactionType:"Transaction type",balance:"Balance"};ReportingHandler.KPI_TITLES={kpi:"Indicator",value:"Value"};ReportingHandler.MAX_TRANSACTION_AGE=2592000000;ReportingHandler.prototype.overview=function(){addHistory("Reporting overview","#reportingOverview","#reporting a");initDefaultContent("Reporting");currentTable="reporting";var l=getDefaultRowContainer({type:"Items available"});var k=[];var b=savingsAccountList.getEntities();var c=b.length;for(var g=0;g<c;g++){var a=b[g];var m=a.transactionList;if(exists(m)){var n=m.length;for(var e=0;e<n;e++){if(Date.now()-m[e].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){k.push(m[e])}}}}var h=loanList.getEntities();var d=h.length;for(var g=0;g<d;g++){var f=h[g];var m=f.transactionList;if(exists(m)){var n=m.length;for(var e=0;e<n;e++){if(Date.now()-m[e].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){k.push(m[e])}}}}addRow(l,{type:"Portfolio analysis"},"Reporting",ReportingHandler.self.rowClickHandler,"getPortfolio");if("SHOWROOM"===tenantId.toUpperCase()){addRow(l,{type:"Key performance indicators"},"Reporting",ReportingHandler.self.rowClickHandler,"keyPerformanceIndicators")}addRow(l,{type:"Clients"},"Client",ReportingHandler.self.rowClickHandler,"getAll");addRow(l,{type:"Loans"},"Loan",ReportingHandler.self.rowClickHandler,"firstGenericLoanReports");addRow(l,{type:"Savings accounts"},"SavingsAccount",ReportingHandler.self.rowClickHandler,"getAll");addRow(l,{type:"Transactions"},"Reporting",ReportingHandler.self.rowClickHandler,"getTransactions")};ReportingHandler.prototype.getTransactions=function(){hideContent();addHistory("Reporting transactions","#reportingTransactions",getSidebarSubitemSelector("reporting","Reporting","getTransactions"));initDefaultContent("");currentTable="transactions";$("#TransactionsAccountReportType").show();$("#TransactionsAccountReportTypeForm").show();document.getElementById("TransactionsAccountReportType").selectedIndex="0";currentChangedFil="ALL";$.datepicker._clearDate($("#tToDatePicker"));$.datepicker._clearDate($("#tFromDatePicker"));transactionsFromDate="0";transactionsToDate="999999999999999";ReportingHandler.prototype.showTransactions()};ReportingHandler.prototype.showTransactions=function(){var k=getDefaultRowContainer(ReportingHandler.TRANSACTION_TITLES);var g=k.parent();var s=[];var f=savingsAccountList.getEntities();var h=f.length;for(var q=0;q<h;q++){var l=f[q];var o=l.transactionList;if(exists(o)){var d=o.length;for(var p=0;p<d;p++){if(Date.now()-o[p].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){if(currentChangedFil==="ALL"){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}else{if(currentChangedFil===o[p]["transactionType"]){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}}}}}}var t=loanList.getEntities();var u=t.length;for(var q=0;q<u;q++){var b=t[q];var o=b.transactionList;if(exists(o)){var d=o.length;for(var p=0;p<d;p++){if(Date.now()-o[p].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){if(currentChangedFil==="ALL"){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}else{if(currentChangedFil===o[p]["transactionType"]){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}}}}}}var n=s.length;for(var q=0;q<n;q++){var r=s[q];var a=ReportingHandler.prototype.getTransactionRowData(r);addRow(k,a,r)}$("#tableTotal").text(n);showContent($("#tableTotalSum"));var m=getDefaultTableSorter();m.headers={0:{sorter:"awamoDateSorter"},2:{sorter:"awamoCurrencySorter"},4:{sorter:"awamoCurrencySorter"}};g.tablesorter(m);var c=document.getElementById("defaultTableContainer").getElementsByTagName("table");for(var q=0;q<c.length;q++){c[q].style.textAlign="right"}addClassToTableColumn(g,0,"currency");addClassToTableColumn(g,2,"currency");addClassToTableColumn(g,4,"currency");var e=$("#defaultTableContainer").tableExport();e.tableExport.update({formats:["xls","xlsx"],fileName:"Transactions",headings:true});$("#hiddenPrintedTitle").val("Transactions Report");$("#printNow").off("click touch");$("#printNow").on("click touch",printData);$("#printNow").show()};ReportingHandler.prototype.getTransactionRowData=function(c){var d={};for(var a in ReportingHandler.TRANSACTION_TITLES){var b=c[a];switch(a){case"accountType":if(exists(c.accountId)){b="savings account"}else{if(exists(c.loanId)){b="loan account"}else{b="unknown"}}break;case"transactionDate":b=formatDate(b);break;case"amount":case"balance":b=exists(b)?formatCurrency(b)+" "+currencyCode:"---";break;default:break}d[a]=String(b)}return d};ReportingHandler.prototype.rowClickHandler=function(){var b=$(this).data("id");var a=$(this).data("object");$('li[data-parent~="reporting"][data-handler="'+a+'"][data-action~="'+b+'"] a').click()};ReportingHandler.prototype.getPortfolio=function(){addHistory("Reporting portfolio","#reportingPortfolio",getSidebarSubitemSelector("reporting","Reporting","getPortfolio"));initDefaultContent("Portfolio");var a=$("#portfolioArea");showContent(a);ReportingHandler.self.createLoansByHealthChart();ReportingHandler.self.createLoansByAgeChart();ReportingHandler.self.createLoansBySexChart();ReportingHandler.self.createLoansBySectorChart()};ReportingHandler.prototype.createLoansByHealthChart=function(){var b=loanList.getEntities().reduce(function(c,d){c[d.health]?c[d.health]++:c[d.health]=1;return c},{});var a=[];$.each(b,function(c,d){a.push({label:c,data:d})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansByHealth")};ReportingHandler.prototype.createLoansByAgeChart=function(){var g={sector0:"< 26",sector1:"26 - 35",sector2:"36 - 45",sector3:"46 - 55",sector4:"> 55"};var c={sector0:0,sector1:0,sector2:0,sector3:0,sector4:0};var f=loanList.getEntities();var b=f.length;for(var d=0;d<b;d++){var e=f[d];if(e.loanType==="INDIVIDUAL"){if(e.client!==null){if(e.client.age<26){c.sector0+=1}else{if(e.client.age<36){c.sector1+=1}else{if(e.client.age<46){c.sector2+=1}else{if(e.client.age<56){c.sector3+=1}else{c.sector4+=1}}}}}}else{if(e.loanType==="GROUP"){}}}var a=[{label:"none",data:0}];$.each(c,function(h,i){a.push({label:g[h],data:i})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansByAge")};ReportingHandler.prototype.createLoansBySexChart=function(){var d={male:0,female:0};var f=loanList.getEntities();var b=f.length;for(var c=0;c<b;c++){var e=f[c];if(e.loanType==="INDIVIDUAL"){if(e.client!==null){if(e.client.gender==="MALE"){d.male+=1}else{d.female+=1}}}}var a=[{label:"none",data:0}];$.each(d,function(g,h){a.push({label:g,data:h})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansBySex")};ReportingHandler.prototype.createLoansBySectorChart=function(){var b=loanList.getEntities().reduce(function(c,f){if(typeof(f.loanClients)!=="undefined"&&f.loanClients!==null&&f.loanClients.length>0){var g=f.loanClients[0];if(typeof(g.clientEmployments)!=="undefined"&&g.clientEmployments!==null&&g.clientEmployments.length>0){var d=g.clientEmployments[0];if(d!==null){var e=null;if(d.selfEmploymentType==="FARMER"){e="FARMER"}else{e=d.businessSector}c[e]?c[e]++:c[e]=1}}}return c},{});var a=[];$.each(b,function(c,d){a.push({label:c,data:d})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansBySector")};ReportingHandler.prototype.dataModelChanged=function(b){var a=$("#portfolio-loansByHealth .chart");if(a.height()>0&&a.width()>0){ReportingHandler.self.createLoansByHealthChart();ReportingHandler.self.createLoansByAgeChart();ReportingHandler.self.createLoansBySexChart();ReportingHandler.self.createLoansBySectorChart()}};ReportingHandler.prototype.labelFormatter=function(a,b){return'<div style="font-size:12px; text-align:center; padding:4px; color: #333333; background-color: '+b.color+'; border: solid 1px #000000">'+a+"<br/>"+Math.round(b.percent)+"%</div>"};ReportingHandler.prototype.getClientMap=function(){addHistory("Geo Information","#geoInformation","#getClientMap a");initDefaultContent("Geo information");showContent($("#geoInformationArea"));currentTable=null;var e=clientList.getEntities();var a={center:new google.maps.LatLng(8.7832,34.5085),zoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:true,mapTypeControl:false,panControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER},zoomControl:true,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.RIGHT_CENTER},scaleControl:false,streetViewControl:false,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}};var d=new google.maps.Map(document.getElementById("geoInformationMap"),a);var c=new google.maps.LatLngBounds();var b=0;e.forEach(function(f){if(exists(f.location)){if(f.location.latitude!==0&&f.location.longitude!==0){var g={lat:f.location.latitude,lng:f.location.longitude};c.extend(new google.maps.LatLng(f.location.latitude,f.location.longitude));b=b+1;new google.maps.Marker({position:g,map:d})}}});if(b>0){d.fitBounds(c)}};ReportingHandler.prototype.keyPerformanceIndicators=function(){addHistory("Key Performance Indicators","#keyPerformanceIndicators",getSidebarSubitemSelector("reporting","Reporting","keyPerformanceIndicators"));initDefaultContent("Key Performance Indicators");ReportingHandler.self.stack(ReportingHandler.prototype.keyPerformanceIndicators);var a=getDefaultRowContainer(ReportingHandler.KPI_TITLES);var b=a.parent();var c=[{kpi:"Return on assets",value:10},{kpi:"Return on equity",value:12}];c.forEach(function(d){addRow(a,ReportingHandler.prototype.getKPIRowData(d))});b.tablesorter(getDefaultTableSorter());addClassToDefaultTableColumn(3,"currency")};ReportingHandler.prototype.getKPIRowData=function(c){var d={};for(var a in ReportingHandler.KPI_TITLES){var b=c[a];switch(a){case"code":if(c.glCode%1000===0){b="<b>"+c.glCode+"</b"}else{if(c.glCode%100===0){b="&emsp;&emsp;"+c.glCode}else{b="&emsp;&emsp;&emsp;&emsp;"+c.glCode}}break;case"name":if(c.glCode%1000===0){b="<b>"+c.name+"</b"}else{if(c.glCode%100===0){b="&emsp;&emsp;"+c.name}else{b="&emsp;&emsp;&emsp;&emsp;"+c.name}}break;case"balance":b=formatCurrency(this._sumOfJournal(c))+" "+currencyCode;break;default:break}d[a]=String(b)}return d};ReportingHandler.prototype.stack=function(b,a){ReportingHandler.self.commandStack.push(b);ReportingHandler.self.argumentStack.push(a)};ReportingHandler.prototype.back=function(){ReportingHandler.self.commandStack.pop()(ReportingHandler.self.argumentStack.pop())};ReportingHandler.prototype.genericTransactionReportSelectHandler=function(){switch($(this).val()){case"ALL":currentChangedFil="ALL";break;case"DEPOSIT":currentChangedFil="DEPOSIT";break;case"WITHDRAWAL":currentChangedFil="WITHDRAWAL";break;case"DISBURSEMENT":currentChangedFil="DISBURSEMENT";break;case"REPAYMENT":currentChangedFil="REPAYMENT";break;default:break}ReportingHandler.prototype.showTransactions()};