
var ShareHandler=function(){ShareHandler.self=this;this.commandStack=[];this.argumentStack=[];$("#singleActions a").off("click touch");$("#singleActions a").on("click touch",ShareHandler.prototype.singleObjectActionHandler)};ShareHandler.APPLICATION_TITLES={clientName:"Client name",numberOfShares:"Number of shares",valueOfShares:"Value of shares"};ShareHandler.CURRENT_MARKET_PRICE=50000;ShareHandler.prototype.purchaseApplication=function(){ShareHandler.self.transactionApplication("purchase")};ShareHandler.prototype.fillClientList=function(){var a=$("#shareClient");a.find("option").not(":first").remove();clientList.getEntities().filter(function(b){return savingsAccountList.getByClient(b.awamoId).length>0}).sort(function(c,b){return c.fullname>b.fullname}).forEach(function(b){a.append($('<option value="'+b.awamoId+'">'+b.fullname+"</option>"))})};ShareHandler.prototype.transactionApplication=function(c){ShareHandler.self.stack(ShareHandler.prototype.transactionApplication);ShareHandler.self.shareApplication=null;initDefaultContent(c+" share");var a=$("#shareClient");var b=$("#shareSavingsAccount");ShareHandler.self.fillClientList();a.off("input");a.on("input",function(){b.find("option").not(":first").remove();savingsAccountList.getByClient($(this).val()).filter(function(d){return d.status==="ACTIVE"}).forEach(function(d){b.append($('<option value="'+d.accountId+'">'+d.accountNo+"</option>"))})});$("#shareCount").off("input");$("#shareCount").on("input",function(){var d=Math.round(Math.abs($(this).val()));if(d===0){$('#singleActions a[data-action="purchase"]').text(c)}else{$('#singleActions a[data-action="purchase"]').text(c+" "+d+" share"+(d===1?"":"s")+" for "+formatCurrency(d*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode)}});$("#shareCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each");$("#shareApplicationForm").data("transactionType",c);$("#shareApplicationForm").off("submit");$("#shareApplicationForm").on("submit",ShareHandler.prototype.submitTransactionApplicationHandler);$("#sharePurchaseDatePicker").datetimepicker({weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:1,pickerPosition:"bottom-center",keyboardNavigation:0});$("#sharePurchaseDatePicker").datetimepicker("setValue");ShareHandler.self.showActionButtons();showContent($("#shareApplication"))};ShareHandler.prototype.submitTransactionApplicationHandler=function(c){if(exists(c)){c.preventDefault()}var b=Math.round(Math.abs($("#shareCount").val()));var a={transactionDate:new Date($("#sharePurchaseDate").val()).getTime(),clientAwamoId:$("#shareClient").val(),savingsAccountId:$("#shareSavingsAccount").val(),requestedShares:b,submittedDate:new Date().getTime(),transactionType:$("#shareApplicationForm").data("transactionType").toUpperCase()};ajax(shareList.rootPath,"POST",function(d){message("Success","successfully submitted application for purchase of "+b+" share"+(b===1?"":"s")+" for "+(b*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode,MessageType.SUCCESS);$("#sharePurchaseDatePicker").datetimepicker("setDate",new Date());$("#shareClient").find("option").not(":first").remove();$("#shareSavingsAccount").find("option").not(":first").remove();$("#shareCount").val("");$('#singleActions a[data-action="purchase"]').text("Purchase");$('#singleActions a[data-action="purchase"]').prop("disabled",true);$("#sharePurchaseDatePicker").blur();$("#shareClient").blur();$("#shareSavingsAccount").blur();$("#shareCount").blur();$('#singleActions a[data-action="purchase"]').blur();ShareHandler.self.fillClientList()},JSON.stringify(a),undefined,function(d){message("Error",d.responseJSON.message,MessageType.WARNING)})};ShareHandler.prototype.sellApplication=function(){ShareHandler.self.stack(ShareHandler.prototype.sellApplication);initDefaultContent("Sell share(s)");var a=$("#shareSaleApplicationClient");a.find("option").not(":first").remove();ajax(shareList.rootPath+"clientsWithShares","GET",function(b){b.forEach(function(d){var c=$('<option value="'+d.clientAwamoId+'" data-max="'+d.numberOfShares+'">'+d.clientName+"</option>");a.append(c)});a.off("input");a.on("input",function(){var c=$(this).find(":selected").data("max");$("#shareSaleApplicationCount").attr("max",c);$("#shareSaleApplicationCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each, min 1 and max "+c+" shares")})});$("#shareSaleApplicationForm").off("submit");$("#shareSaleApplicationForm").on("submit",ShareHandler.prototype.submitSellApplicationHandler);ShareHandler.self.shareApplication={status:"WANT_TO_SELL"};ShareHandler.self.showActionButtons();showContent($("#shareSaleApplication"))};ShareHandler.prototype.submitSellApplicationHandler=function(d){if(exists(d)){d.preventDefault()}var a=$("#shareSaleApplicationClient");var c=Math.round(Math.abs($("#shareSaleApplicationCount").val()));var b={transactionDate:new Date().getTime(),clientAwamoId:a.val(),requestedShares:c,submittedDate:new Date().getTime(),transactionType:"SALE"};ajax(shareList.rootPath,"POST",function(e){message("Success","successfully submitted application for sale of "+c+" share"+(c===1?"":"s")+" for "+(c*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode,MessageType.SUCCESS);$("#shareSaleApplicationCount").val("");$("#shareSaleApplicationCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each");$('#singleActions a[data-action="sell"]').text("Sell");$('#singleActions a[data-action="sell"]').prop("disabled",true);a.blur();$("#shareSaleApplicationCount").blur();$('#singleActions a[data-action="sell"]').blur();a.find("option").not(":first").remove();ajax(shareList.rootPath+"clientsWithShares","GET",function(f){f.forEach(function(h){var g=$('<option value="'+h.clientAwamoId+'" data-max="'+h.numberOfShares+'">'+h.clientName+"</option>");a.append(g)});a.off("input");a.on("input",function(){var g=$(this).find(":selected").data("max");$("#shareSaleApplicationCount").attr("max",g);$("#shareSaleApplicationCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each, min 1 and max "+g+" shares")})})},JSON.stringify(b),undefined,function(e){message("Error",e.responseJSON.message,MessageType.WARNING)})};ShareHandler.prototype.approvePurchase=function(){ShareHandler.self.stack(ShareHandler.prototype.approvePurchase);initDefaultContent("Purchase applications");var a=getDefaultRowContainer(ShareHandler.APPLICATION_TITLES);ajax(shareList.rootPath+"listApplications?transactionType=PURCHASE","GET",function(b){ShareHandler.self.counter=b.length;if(ShareHandler.self.counter===0){tableMessage("no applications found")}b.forEach(function(c){clientList.get(c.clientAwamoId,function(d){c.client=d;c.status="SUBMITTED_FOR_PURCHASE";savingsAccountList.get(c.savingsAccountId,function(e){c.savingsAccount=e;addRow(a,ShareHandler.self.getShareRowData(c),c,ShareHandler.self.approvePurchaseRowClickHandler,c.clientAwamoId);ShareHandler.self.counter=ShareHandler.self.counter-1;if(ShareHandler.self.counter===0){a.parent().tablesorter(getDefaultTableSorter("unsorted"));addClassToTableColumn(a.parent(),2,"currency")}})})})});showContent($("#defaultTableContainer"))};ShareHandler.prototype.approvePurchaseRowClickHandler=function(){$("#approveNo").off("click touch");$("#approveNo").on("click touch",ShareHandler.prototype.back);$("#rejectNo").off("click touch");$("#rejectNo").on("click touch",ShareHandler.prototype.back);$("#approveYes").off("click touch");$("#approveYes").on("click touch",ShareHandler.prototype.approvePurchaseApplication);$("#rejectYes").off("click touch");$("#rejectYes").on("click touch",ShareHandler.prototype.rejectPurchaseApplication);$("#approveApplication .panel-body .approvalObject").text("share purchase");$("#rejectApplication .panel-body .rejectionObject").text("share purchase");ShareHandler.self.displaySingleShare($(this).data("object"))};ShareHandler.prototype.approvePurchaseApplication=function(){ShareHandler.self.shareApplication.status="APPROVED_PURCHASE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/approvePurchase","POST",ShareHandler.prototype.approvePurchaseApplicationSuccessful);window.setTimeout(function(){ShareHandler.self.back();ShareHandler.self.back()},1000)};ShareHandler.prototype.approvePurchaseApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="APPROVED_PURCHASE"};ShareHandler.prototype.rejectPurchaseApplication=function(){ShareHandler.self.shareApplication.status="REJECTED_PURCHASE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/rejectPurchase","POST",ShareHandler.prototype.rejectPurchaseApplicationSuccessful,'{"note":"'+$("#rejectionNote").val()+'"}');ShareHandler.self.back();ShareHandler.self.back()};ShareHandler.prototype.rejectPurchaseApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="REJECTED_PURCHASE"};ShareHandler.prototype.saleRowClickHandler=function(){var a=$(this).data("object");ShareHandler.self.displaySingleShare(a);$("#shareSaleCount").val(a.requestedShares)};ShareHandler.prototype.approveSale=function(){ShareHandler.self.stack(ShareHandler.prototype.approveSale);initDefaultContent("Sale applications");var a=getDefaultRowContainer(ShareHandler.APPLICATION_TITLES);ajax(shareList.rootPath+"listApplications?transactionType=SALE","GET",function(b){ShareHandler.self.counter=b.length;if(ShareHandler.self.counter===0){tableMessage("no applications found")}b.forEach(function(c){clientList.get(c.clientAwamoId,function(d){c.client=d;c.status="SUBMITTED_FOR_SALE";savingsAccountList.get(c.savingsAccountId,function(e){c.savingsAccount=e;addRow(a,ShareHandler.self.getShareRowData(c),c,ShareHandler.self.approveSaleRowClickHandler,c.clientAwamoId);ShareHandler.self.counter=ShareHandler.self.counter-1;if(ShareHandler.self.counter===0){a.parent().tablesorter(getDefaultTableSorter("unsorted"));addClassToTableColumn(a.parent(),2,"currency")}})})})});showContent($("#defaultTableContainer"))};ShareHandler.prototype.approveSaleRowClickHandler=function(){$("#approveNo").off("click touch");$("#approveNo").on("click touch",ShareHandler.prototype.back);$("#rejectNo").off("click touch");$("#rejectNo").on("click touch",ShareHandler.prototype.back);$("#approveYes").off("click touch");$("#approveYes").on("click touch",ShareHandler.prototype.approveSaleApplication);$("#rejectYes").off("click touch");$("#rejectYes").on("click touch",ShareHandler.prototype.rejectSaleApplication);$("#approveApplication .panel-body .approvalObject").text("share sale");$("#rejectApplication .panel-body .rejectionObject").text("share sale");ShareHandler.self.displaySingleShare($(this).data("object"))};ShareHandler.prototype.approveSaleApplication=function(){ShareHandler.self.shareApplication.status="APPROVED_SALE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/approveSale","POST",ShareHandler.prototype.approveSaleApplicationSuccessful);window.setTimeout(function(){ShareHandler.self.back();ShareHandler.self.back()},1000)};ShareHandler.prototype.approveSaleApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="APPROVED_SALE"};ShareHandler.prototype.rejectSaleApplication=function(){ShareHandler.self.shareApplication.status="REJECTED_SALE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/rejectSale","POST",ShareHandler.prototype.rejectPurchaseApplicationSuccessful,'{"note":"'+$("#rejectionNote").val()+'"}');ShareHandler.self.back();ShareHandler.self.back()};ShareHandler.prototype.rejectSaleApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="REJECTED_SALE"};ShareHandler.prototype.displayApprove=function(a){ShareHandler.self.stack(ShareHandler.prototype.displayApprove,a);hideContent();showContent($("#approveApplication"))};ShareHandler.prototype.displayReject=function(a){ShareHandler.self.stack(ShareHandler.prototype.displayReject,a);hideContent();$("#rejectionNote").val("");showContent($("#rejectApplication"))};ShareHandler.prototype.getShareRowData=function(c){var d={};for(var a in ShareHandler.APPLICATION_TITLES){var b=c[a];switch(a){case"clientName":b=c.client.fullname;break;case"numberOfShares":b=c.requestedShares;break;case"valueOfShares":b=formatCurrency(parseInt(c.requestedShares)*parseInt(ShareHandler.CURRENT_MARKET_PRICE))+" "+currencyCode;break;default:break}d[a]=String(b)}return d};ShareHandler.prototype.displaySingleShareApplication=function(a){ShareHandler.self.stack(ShareHandler.prototype.displaySingleShare,a);ShareHandler.self.shareApplication=a;hideContent();$("#singleSharePurchaseDate").val(formatDate(a.submittedDate));$("#singleShareClient").val(a.awamoId);$("#singleShareSavingsAccount").val(a.savingsAccount.accountNo);$("#singleShareCount").val(a.requestedShares);$("#singleShareCount").next(".input-group-addon").text(ShareHandler.CURRENT_MARKET_PRICE+" "+currencyCode);ShareHandler.self.showActionButtons();showContent($("#singleShare"))};ShareHandler.prototype.displaySingleShare=function(a){ShareHandler.self.stack(ShareHandler.prototype.displaySingleShare,a);ShareHandler.self.shareApplication=a;hideContent();$("#singleSharePurchaseDate").val(formatDate(a.transactionDate));$("#singleShareClient").val(a.client.fullname);$("#singleShareSavingsAccount").val(a.savingsAccount.accountNo);$("#singleShareCount").val(a.requestedShares);$("#singleShareCountValue").val(formatCurrency(a.requestedShares*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode);ShareHandler.self.showActionButtons();showContent($("#singleShare"))};ShareHandler.prototype.singleObjectActionHandler=function(){var a=$(this).data("action");switch(a){case"approve":ShareHandler.self.displayApprove(ShareHandler.self.shareApplication);break;case"reject":ShareHandler.self.displayReject(ShareHandler.self.shareApplication);break;case"back":ShareHandler.self.back();break;case"purchase":$('#shareApplicationForm input[type="submit"]').click();break;case"sell":$('#shareSaleApplicationForm input[type="submit"]').click();break;default:break}};ShareHandler.prototype.showActionButtons=function(){$("#singleActions a[data-action]").hide();if(ShareHandler.self.shareApplication===null){$('#singleActions a[data-action="purchase"]').show()}else{$('#singleActions a[data-action="back"]').show();switch(ShareHandler.self.shareApplication.status){case"WANT_TO_SELL":$('#singleActions a[data-action="sell"]').show();break;case"SUBMITTED_FOR_PURCHASE":case"SUBMITTED_FOR_SALE":$('#singleActions a[data-action="approve"]').show();$('#singleActions a[data-action="reject"]').show();break;case"ACTIVE":$('#singleActions a[data-action="sell"]').show();break;default:break}}showContent($("#singleActions"))};ShareHandler.prototype.dataModelChanged=function(){};ShareHandler.prototype.entityChanged=function(a,b){};ShareHandler.prototype.stack=function(b,a){ShareHandler.self.commandStack.push(b);ShareHandler.self.argumentStack.push(a)};ShareHandler.prototype.back=function(){ShareHandler.self.commandStack.pop();ShareHandler.self.argumentStack.pop();ShareHandler.self.commandStack.pop()(ShareHandler.self.argumentStack.pop())};