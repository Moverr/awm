
function AbstractList(){this.mainIds=[];this.entityMap={};this.entityArray=[];this.dataModelChangedEventListenerCallbacks=[];this.entityChangedEventListenerCallbacks=[];this.callbacks={};this.reloadIds=[];this.reloadInProgress=false}AbstractList.prototype={rootPath:null,storagePrefix:null,constructor:AbstractList,initLocal:function(a){this.loadAllFromLocal(a)},init:function(a){var c=[];a.forEach(function(d){c.push(d)});this.initLocal(c);if(!this.updated){this.updated=true;this.loadAll(a);var b=this;this.reloadTimer=window.setInterval(function(){b.loadAll()},1000*60*30)}},reload:function(){this.loadAll()},get:function(b,a){a(this.entityMap[b])},getTotalCount:function(){return this.mainIds.length},getMainIds:function(){return this.mainIds},getEntities:function(){return this.entityArray},addDataModelChangedEventListenerCallback:function(a){this.dataModelChangedEventListenerCallbacks.push(a)},removeDataModelChangedEventListenerCallback:function(a){var b=this.dataModelChangedEventListenerCallbacks.indexOf(a);if(b>-1){this.dataModelChangedEventListenerCallbacks.splice(b,1)}},addEntityChangedEventListenerCallback:function(a){this.entityChangedEventListenerCallbacks.push(a)},removeEntityChangedEventListenerCallback:function(b){var a=this.entityChangedEventListenerCallbacks.indexOf(b);if(a>-1){this.entityChangedEventListenerCallbacks.splice(a,1)}},store:function(b){b=this.enrich(b);var d=eventtype.CREATE;var a=this.entityArray.length;var c=0;for(;c<a;c++){if(this.entityArray[c].mainId===b.mainId){if(this.equals(this.entityArray[c],b)){d=eventtype.UNCHANGED}else{d=eventtype.UPDATE}break}}if(d!==eventtype.UNCHANGED){if(!this.mainIds.includes(b.mainId)){this.mainIds.push(b.mainId)}this.entityMap[b.mainId]=b;this.entityArray[c]=b;if(typeof(Storage)!=="undefined"){localStorage.setItem(this.storagePrefix+b.mainId,JSON.stringify(b))}this.notifyEntityChangedListener(b,d);this.notifyDataModelChangedListener()}},loadOne:function(c,b){this.callbacks[c]=[b];var a=this;ajax(this.rootPath+c,"GET",function(d){a.store(d);try{var f=a.callbacks[c].pop();while(exists(f)){f(d);f=a.callbacks[c].pop()}}catch(e){}delete a.callbacks[c]},null,undefined,function(){b(null)})},loadAllFromLocal:function(b){if(typeof(Storage)!=="undefined"){for(var e=0,a=localStorage.length;e<a;++e){var d=localStorage.key(e);if(d.startsWith(this.storagePrefix)){var g=localStorage.getItem(d);var c=JSON.parse(g);this.store(c)}}if(Array.isArray(b)){var f=b.shift();if(exists(f)){f.initLocal(b)}}}},loadAll:function(b){var h=[];if(typeof(Storage)!=="undefined"){for(var f=0,a=localStorage.length;f<a;++f){var e=localStorage.key(f);if(e.startsWith(this.storagePrefix)){var g=localStorage.getItem(e);var d=JSON.parse(g);h.push(d.mainId);this.store(d)}}}var c=this;ajax(this.rootPath+"mainIds/0","GET",function(i){h.forEach(function(j){if(!i.includes(j)){if(typeof(Storage)!=="undefined"){localStorage.removeItem(c.storagePrefix+j)}c.mainIds.remove(j);delete c.entityMap[j];c.entityArray=c.entityArray.filter(function(k){return k.mainId!==j});c.notifyDataModelChangedListener();c.notifyEntityChangedListener(j,eventtype.DELETE)}});i.sort(function(k,j){return parseInt(k)>parseInt(j)}).reverse();c.reloadIds=i;if(!c.reloadInProgress){c.loadNext(c,b)}})},loadNext:function(b,a){if(!exists(b.reloadIds)){return}var d=b.reloadIds.shift();if(exists(d)){b.reloadInProgress=true;ajax(b.rootPath+d,"GET",function(e){b.put(b,e,b.loadNext,a)},undefined,undefined,function(){b.loadNext(b,a)})}else{b.reloadInProgress=false;if(Array.isArray(a)){var c=a.shift();if(exists(c)){c.init(a)}}}},put:function(b,a,d,c){b.store(a);statusbar("synchronizing "+b.entityName+"s, "+b.reloadIds.length+" left to load");if($.isFunction(d)){d(b,c)}},notifyDataModelChangedListener:function(){this.dataModelChangedEventListenerCallbacks.forEach(function(a){a()})},notifyEntityChangedListener:function(a,b){this.entityChangedEventListenerCallbacks.forEach(function(c){c(a,b)})},sorter:function(b,a){return b>a},equals:function(e,f){if(e===f){return true}if(!exists(e)||!exists(f)){return false}var j=Object.keys(e).sort();var a=Object.keys(f).sort();var h=j.length;var g=a.length;if(h!==g){return false}for(var d=0;d<h;d++){var b=j[d];var c=a[d];if(b!==c){return false}else{if(e[b]!==f[c]){return false}}}return true},getById:function(c){var b=function(d){return d.mainId===c};var a=this.getEntities().filter(b);if(a.length===1){return a[0]}return null}};